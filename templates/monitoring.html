{% extends "base.html" %}

{% block title %}AI Monitoring Dashboard - {{ server.name }} - AI4K8s{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">AI Monitoring Dashboard</h2>
        <p class="text-muted">Predictive analytics and intelligent insights for <strong>{{ server.name }}</strong></p>
        <small class="text-muted">
            <i class="fas fa-server me-1"></i>{{ server.server_type.title() }} Server
            <span class="badge bg-{% if server.status == 'active' %}success{% elif server.status == 'inactive' %}warning{% else %}danger{% endif %} ms-2">
                {{ server.status.title() }}
            </span>
        </small>
        <div id="demoModeIndicator" class="alert alert-info mt-2" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Demo Mode:</strong> Using synthetic data for demonstration. Connect to a real Kubernetes cluster for live monitoring.
        </div>
    </div>
    <div>
        <button id="startMonitoring" class="btn btn-success me-2">
            <i class="fas fa-play me-2"></i>Start Monitoring
        </button>
        <button id="stopMonitoring" class="btn btn-danger me-2">
            <i class="fas fa-stop me-2"></i>Stop Monitoring
        </button>
        <button id="refreshData" class="btn btn-primary">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Health Score Card -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="text-primary mb-2">
                    <i class="fas fa-heartbeat fa-2x"></i>
                </div>
                <h4 id="healthScore" class="mb-1">--</h4>
                <p class="text-muted mb-0">Health Score</p>
                <small id="healthStatus" class="text-muted">--</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="text-info mb-2">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
                <h4 id="alertCount" class="mb-1">--</h4>
                <p class="text-muted mb-0">Active Alerts</p>
                <small id="alertSeverity" class="text-muted">--</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="text-warning mb-2">
                    <i class="fas fa-lightbulb fa-2x"></i>
                </div>
                <h4 id="recommendationCount" class="mb-1">--</h4>
                <p class="text-muted mb-0">Recommendations</p>
                <small id="recommendationPriority" class="text-muted">--</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="text-success mb-2">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <h4 id="forecastTrend" class="mb-1">--</h4>
                <p class="text-muted mb-0">CPU Trend</p>
                <small id="forecastRecommendation" class="text-muted">--</small>
            </div>
        </div>
    </div>
</div>

<!-- Current Metrics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header border-bottom">
                <h5 class="mb-0 text-light"><i class="fas fa-tachometer-alt me-2"></i>Current Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>CPU Usage:</span>
                            <span id="currentCpu" class="fw-bold">--</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px;">
                            <div id="cpuProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Memory Usage:</span>
                            <span id="currentMemory" class="fw-bold">--</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px;">
                            <div id="memoryProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Pod Count:</span>
                            <span id="currentPods" class="fw-bold">--</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Node Count:</span>
                            <span id="currentNodes" class="fw-bold">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header border-bottom">
                <h5 class="mb-0 text-light"><i class="fas fa-crystal-ball me-2"></i>Predictions</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>CPU Forecast (Next 6 Hours)</h6>
                    <div id="cpuForecast" class="text-muted">Loading...</div>
                </div>
                <div class="mb-3">
                    <h6>Memory Forecast (Next 6 Hours)</h6>
                    <div id="memoryForecast" class="text-muted">Loading...</div>
                </div>
                <div class="mb-3">
                    <h6>Trend Analysis</h6>
                    <div id="trendAnalysis" class="text-muted">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts and Recommendations -->
<div class="row">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header border-bottom">
                <h5 class="mb-0 text-light"><i class="fas fa-bell me-2"></i>Anomaly Alerts</h5>
            </div>
            <div class="card-body">
                <div id="alertsList">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading alerts...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header border-bottom">
                <h5 class="mb-0 text-light"><i class="fas fa-magic me-2"></i>AI Recommendations</h5>
            </div>
            <div class="card-body">
                <div id="recommendationsList">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading recommendations...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.5); z-index: 9999; display: none;">
    <div class="text-center text-light">
        <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
        <h4>Analyzing Cluster Data...</h4>
        <p>AI is processing metrics and generating insights</p>
    </div>
</div>

<script>
let monitoringInterval = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, starting dashboard initialization');
    loadDashboardData();
    
    // Set up auto-refresh every 30 seconds
    monitoringInterval = setInterval(loadDashboardData, 30000);
});

// Load all dashboard data
async function loadDashboardData() {
    try {
        console.log('üîÑ Starting to load dashboard data...');
        showLoading(true);
        
        const serverId = {{ server.id }};
        console.log(`üìä Loading data for server ${serverId}`);
        
        // Load all data in parallel
        const [insights, alerts, recommendations, forecast, health] = await Promise.all([
            fetch(`/api/monitoring/insights/${serverId}`).then(r => r.json()),
            fetch(`/api/monitoring/alerts/${serverId}`).then(r => r.json()),
            fetch(`/api/monitoring/recommendations/${serverId}`).then(r => r.json()),
            fetch(`/api/monitoring/forecast/${serverId}`).then(r => r.json()),
            fetch(`/api/monitoring/health/${serverId}`).then(r => r.json())
        ]);
        
        console.log('‚úÖ All API calls completed');
        
        // Debug: Log the API responses
        console.log('API Responses:', {
            insights: insights,
            alerts: alerts,
            recommendations: recommendations,
            forecast: forecast,
            health: health
        });
        
        console.log('üîÑ Updating dashboard with received data...');
        updateDashboard(insights, alerts, recommendations, forecast, health);
        
        // Show demo mode indicator if in demo mode
        const demoIndicator = document.getElementById('demoModeIndicator');
        if (demoIndicator) {
            if (insights && insights.demo_mode) {
                console.log('üé≠ Demo mode detected, showing indicator');
                demoIndicator.style.display = 'block';
            } else {
                console.log('üîó Live mode detected, hiding demo indicator');
                demoIndicator.style.display = 'none';
            }
        } else {
            console.log('‚ö†Ô∏è Demo mode indicator element not found');
        }
        
        console.log('‚úÖ Dashboard update completed');
        
    } catch (error) {
        console.error('‚ùå Error loading dashboard data:', error);
        showError('Failed to load monitoring data: ' + error.message);
    } finally {
        console.log('üîÑ Hiding loading overlay...');
        showLoading(false);
        console.log('‚úÖ Loading overlay hidden');
        
        // Double-check that overlay is actually hidden
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            const isVisible = window.getComputedStyle(overlay).display !== 'none';
            console.log('üîß Final overlay visibility check:', isVisible ? 'VISIBLE' : 'HIDDEN');
            if (isVisible) {
                console.log('‚ö†Ô∏è Overlay is still visible, forcing hide...');
                overlay.style.setProperty('display', 'none', 'important');
                overlay.style.visibility = 'hidden';
                overlay.style.opacity = '0';
            }
        }
    }
}

// Update dashboard with data
function updateDashboard(insights, alerts, recommendations, forecast, health) {
    console.log('Updating dashboard with:', { insights, alerts, recommendations, forecast, health });
    
    // Check if we have any valid data
    const hasValidData = (health && !health.error) || (insights && !insights.error) || (alerts && !alerts.error);
    
    if (!hasValidData) {
        console.log('No valid data received, showing error state');
        console.log('Health:', health);
        console.log('Insights:', insights);
        console.log('Alerts:', alerts);
        showError('No monitoring data available. Check if Kubernetes is running and accessible.');
        return;
    }
    
    console.log('‚úÖ Valid data received, updating dashboard');
    
    // Update health score
    if (health && !health.error) {
        const healthScoreEl = document.getElementById('healthScore');
        const healthStatusEl = document.getElementById('healthStatus');
        
        if (healthScoreEl) {
            healthScoreEl.textContent = health.overall_score + '%';
        }
        if (healthStatusEl) {
            healthStatusEl.textContent = health.status.toUpperCase();
        }
        
        // Update health score color
        const healthCard = document.querySelector('.col-md-3:first-child .card');
        healthCard.className = healthCard.className.replace(/border-\w+/, '');
        if (health.overall_score >= 80) {
            healthCard.classList.add('border-success');
        } else if (health.overall_score >= 60) {
            healthCard.classList.add('border-warning');
        } else {
            healthCard.classList.add('border-danger');
        }
    }
    
    // Update alerts
    if (alerts && !alerts.error) {
        document.getElementById('alertCount').textContent = alerts.count;
        updateAlertsList(alerts.alerts);
        
        if (alerts.count > 0) {
            const severity = alerts.alerts.some(a => a.severity === 'critical') ? 'Critical' :
                           alerts.alerts.some(a => a.severity === 'high') ? 'High' : 'Medium';
            document.getElementById('alertSeverity').textContent = severity;
        } else {
            document.getElementById('alertSeverity').textContent = 'None';
        }
    }
    
    // Update recommendations
    if (recommendations && !recommendations.error) {
        document.getElementById('recommendationCount').textContent = recommendations.count;
        updateRecommendationsList(recommendations.recommendations);
        
        if (recommendations.count > 0) {
            const priority = recommendations.recommendations.some(r => r.priority === 'high') ? 'High' :
                           recommendations.recommendations.some(r => r.priority === 'medium') ? 'Medium' : 'Low';
            document.getElementById('recommendationPriority').textContent = priority;
        } else {
            document.getElementById('recommendationPriority').textContent = 'None';
        }
    }
    
    // Update current metrics
    if (insights && !insights.error && insights.current_metrics) {
        const metrics = insights.current_metrics;
        
        document.getElementById('currentCpu').textContent = metrics.cpu_usage.toFixed(1) + '%';
        document.getElementById('currentMemory').textContent = metrics.memory_usage.toFixed(1) + '%';
        document.getElementById('currentPods').textContent = metrics.pod_count;
        document.getElementById('currentNodes').textContent = metrics.node_count;
        
        // Update progress bars
        document.getElementById('cpuProgress').style.width = metrics.cpu_usage + '%';
        document.getElementById('memoryProgress').style.width = metrics.memory_usage + '%';
        
        // Update progress bar colors
        const cpuProgress = document.getElementById('cpuProgress');
        const memoryProgress = document.getElementById('memoryProgress');
        
        cpuProgress.className = 'progress-bar ' + (metrics.cpu_usage > 80 ? 'bg-danger' : metrics.cpu_usage > 60 ? 'bg-warning' : 'bg-success');
        memoryProgress.className = 'progress-bar bg-info ' + (metrics.memory_usage > 80 ? 'bg-danger' : metrics.memory_usage > 60 ? 'bg-warning' : 'bg-success');
    }
    
    // Update forecasts
    if (forecast && !forecast.error) {
        document.getElementById('forecastTrend').textContent = forecast.cpu_forecast.trend.toUpperCase();
        document.getElementById('forecastRecommendation').textContent = forecast.cpu_forecast.recommendation;
        
        updateForecasts(forecast);
    }
}

// Update alerts list
function updateAlertsList(alerts) {
    const alertsList = document.getElementById('alertsList');
    
    if (alerts.length === 0) {
        alertsList.innerHTML = '<div class="text-center text-success"><i class="fas fa-check-circle me-2"></i>No active alerts</div>';
        return;
    }
    
    alertsList.innerHTML = alerts.map(alert => `
        <div class="alert alert-${getSeverityClass(alert.severity)} alert-dismissible fade show mb-2">
            <div class="d-flex align-items-center">
                <i class="fas fa-${getSeverityIcon(alert.severity)} me-2"></i>
                <div>
                    <strong>${alert.severity.toUpperCase()}</strong>: ${alert.message}
                    <br><small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                </div>
            </div>
        </div>
    `).join('');
}

// Update recommendations list
function updateRecommendationsList(recommendations) {
    const recommendationsList = document.getElementById('recommendationsList');
    
    if (recommendations.length === 0) {
        recommendationsList.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>No recommendations</div>';
        return;
    }
    
    recommendationsList.innerHTML = recommendations.map(rec => `
        <div class="card mb-2 border-${getPriorityClass(rec.priority)}">
            <div class="card-body p-3">
                <div class="d-flex align-items-start">
                    <i class="fas fa-${getRecommendationIcon(rec.type)} me-2 mt-1 text-${getPriorityClass(rec.priority)}"></i>
                    <div>
                        <h6 class="mb-1">${rec.type.toUpperCase()}</h6>
                        <p class="mb-1">${rec.message}</p>
                        <small class="text-muted">Priority: ${rec.priority}</small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Update forecasts
function updateForecasts(forecast) {
    const cpuForecast = document.getElementById('cpuForecast');
    const memoryForecast = document.getElementById('memoryForecast');
    const trendAnalysis = document.getElementById('trendAnalysis');
    
    if (forecast.cpu_forecast && forecast.cpu_forecast.next_hour_prediction !== undefined && forecast.cpu_forecast.next_hour_prediction !== null) {
        cpuForecast.innerHTML = `
            <div class="d-flex justify-content-between">
                <span>Current: ${forecast.cpu_forecast.current.toFixed(1)}%</span>
                <span>Next Hour: ${forecast.cpu_forecast.next_hour_prediction.toFixed(1)}%</span>
            </div>
            <div class="progress mt-1" style="height: 6px;">
                <div class="progress-bar bg-primary" style="width: ${forecast.cpu_forecast.next_hour_prediction}%"></div>
            </div>
        `;
    }
    
    if (forecast.memory_forecast && forecast.memory_forecast.next_hour_prediction !== undefined && forecast.memory_forecast.next_hour_prediction !== null) {
        memoryForecast.innerHTML = `
            <div class="d-flex justify-content-between">
                <span>Current: ${forecast.memory_forecast.current.toFixed(1)}%</span>
                <span>Next Hour: ${forecast.memory_forecast.next_hour_prediction.toFixed(1)}%</span>
            </div>
            <div class="progress mt-1" style="height: 6px;">
                <div class="progress-bar bg-info" style="width: ${forecast.memory_forecast.next_hour_prediction}%"></div>
            </div>
        `;
    }
    
    trendAnalysis.innerHTML = `
        <div class="row">
            <div class="col-6">
                <small>CPU: <span class="text-${forecast.cpu_forecast.trend === 'increasing' ? 'danger' : forecast.cpu_forecast.trend === 'decreasing' ? 'success' : 'info'}">${forecast.cpu_forecast.trend}</span></small>
            </div>
            <div class="col-6">
                <small>Memory: <span class="text-${forecast.memory_forecast.trend === 'increasing' ? 'danger' : forecast.memory_forecast.trend === 'decreasing' ? 'success' : 'info'}">${forecast.memory_forecast.trend}</span></small>
            </div>
        </div>
    `;
}

// Helper functions
function getSeverityClass(severity) {
    const classes = {
        'low': 'info',
        'medium': 'warning',
        'high': 'danger',
        'critical': 'danger'
    };
    return classes[severity] || 'info';
}

function getSeverityIcon(severity) {
    const icons = {
        'low': 'info-circle',
        'medium': 'exclamation-triangle',
        'high': 'exclamation-circle',
        'critical': 'times-circle'
    };
    return icons[severity] || 'info-circle';
}

function getPriorityClass(priority) {
    const classes = {
        'low': 'info',
        'medium': 'warning',
        'high': 'danger'
    };
    return classes[priority] || 'info';
}

function getRecommendationIcon(type) {
    const icons = {
        'performance': 'tachometer-alt',
        'capacity': 'expand-arrows-alt',
        'predictive_scaling': 'chart-line'
    };
    return icons[type] || 'lightbulb';
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        if (show) {
            overlay.style.display = 'flex';
            console.log('üîÑ Showing loading overlay');
            console.log('üîß Overlay display style:', overlay.style.display);
        } else {
            overlay.style.display = 'none';
            overlay.style.setProperty('display', 'none', 'important');
            console.log('‚úÖ Hiding loading overlay');
            console.log('üîß Overlay display style after hiding:', overlay.style.display);
            console.log('üîß Overlay computed style:', window.getComputedStyle(overlay).display);
        }
    } else {
        console.log('‚ö†Ô∏è Loading overlay element not found');
    }
}

function showError(message) {
    // Create and show error alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Event listeners
document.getElementById('refreshData').addEventListener('click', loadDashboardData);

document.getElementById('startMonitoring').addEventListener('click', async function() {
    try {
        const serverId = {{ server.id }};
        const response = await fetch(`/api/monitoring/start/${serverId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({interval: 300})
        });
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Monitoring started successfully');
        } else {
            showError('Failed to start monitoring: ' + result.error);
        }
    } catch (error) {
        showError('Failed to start monitoring: ' + error.message);
    }
});

document.getElementById('stopMonitoring').addEventListener('click', async function() {
    try {
        const serverId = {{ server.id }};
        const response = await fetch(`/api/monitoring/stop/${serverId}`, {method: 'POST'});
        const result = await response.json();
        
        if (result.success) {
            showSuccess('Monitoring stopped successfully');
        } else {
            showError('Failed to stop monitoring: ' + result.error);
        }
    } catch (error) {
        showError('Failed to stop monitoring: ' + error.message);
    }
});

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (monitoringInterval) {
        clearInterval(monitoringInterval);
    }
});
</script>
{% endblock %}
