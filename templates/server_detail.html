{% extends "base.html" %}

{% block title %}{{ server.name }} - AI4K8s{% endblock %}

{% block content %}
<div class="d-grid" style="grid-template-columns: 1fr; gap: 2rem;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">{{ server.name }}</h1>
            <p class="text-muted">Cluster details and management options</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Dashboard
            </a>
        </div>
    </div>

    <!-- Cluster Information -->
    <div class="d-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Cluster Information</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Server ID:</strong></p>
                    <span class="badge badge-primary">{{ server.id }}</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Connection String:</strong></p>
                    <code style="background: var(--surface-hover); padding: 0.5rem; border-radius: 0.25rem; display: block; word-break: break-all; font-size: 0.875rem;">{{ server.connection_string or 'Not configured' }}</code>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Server Type:</strong></p>
                    <span class="badge badge-info">{{ server.server_type.title() }}</span>
                </div>
                
                {% if server.username %}
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Username:</strong></p>
                    <code style="background: var(--surface-hover); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">{{ server.username }}</code>
                </div>
                {% endif %}
                
                {% if server.ssh_port and server.ssh_port != 22 %}
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>SSH Port:</strong></p>
                    <span class="badge badge-secondary">{{ server.ssh_port }}</span>
                </div>
                {% endif %}
                
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Default Namespace:</strong></p>
                    <span class="badge badge-info">{{ server.namespace }}</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Status:</strong></p>
                    <span class="badge badge-{{ 'success' if server.status == 'active' else 'warning' if server.status == 'monitoring' else 'error' }}">
                        {{ server.status.title() }}
                    </span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Connection Timeout:</strong></p>
                    <span class="badge badge-secondary">{{ server.connection_timeout }}s</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>SSL Verification:</strong></p>
                    <span class="badge badge-{{ 'success' if server.verify_ssl else 'warning' }}">
                        {{ 'Enabled' if server.verify_ssl else 'Disabled' }}
                    </span>
                </div>
                
                {% if server.last_connection_test %}
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Last Connection Test:</strong></p>
                    <p class="mb-0">{{ server.last_connection_test.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
                {% endif %}
                
                {% if server.last_accessed %}
                <div style="margin-bottom: 1rem;">
                    <p class="text-muted mb-1"><strong>Last Accessed:</strong></p>
                    <p class="mb-0">{{ server.last_accessed.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
                {% endif %}
                
                <div>
                    <p class="text-muted mb-1"><strong>Added:</strong></p>
                    <p class="mb-0">{{ server.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
                
                {% if server.connection_error %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--error-color); color: white; border-radius: 0.5rem;">
                    <p class="mb-1"><strong>Connection Error:</strong></p>
                    <p class="mb-0" style="font-size: 0.875rem;">{{ server.connection_error }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="d-grid" style="grid-template-columns: 1fr; gap: 0.75rem;">
                    <a href="{{ url_for('chat', server_id=server.id) }}" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Start AI Chat
                    </a>
                    
                    <a href="{{ url_for('monitoring_dashboard', server_id=server.id) }}" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M9 19C9 20.1046 8.10457 21 7 21C5.89543 21 5 20.1046 5 19C5 17.8954 5.89543 17 7 17C8.10457 17 9 17.8954 9 19Z"/>
                            <path d="M19 19C19 20.1046 18.1046 21 17 21C15.8954 21 15 20.1046 15 19C15 17.8954 15.8954 17 17 17C18.1046 17 19 17.8954 19 19Z"/>
                            <path d="M9 19H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        AI Monitoring
                    </a>

                    <a href="{{ url_for('autoscaling_page', server_id=server.id) }}" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M8 6H16V14H8V6Z"/>
                            <path d="M16 6H20V10H16V6Z"/>
                            <path d="M8 14H16V18H8V14Z"/>
                            <path d="M16 14H20V18H16V14Z"/>
                        </svg>
                        Autoscaling
                    </a>
                    
                    <button onclick="testConnection()" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Test Connection
                    </button>
                    
                    <button onclick="deleteServer({{ server.id }})" class="btn btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Delete Cluster
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Activity</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User Message</th>
                            <th>AI Response</th>
                            <th>Tool Used</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chat in recent_chats %}
                        <tr>
                            <td>{{ chat.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ chat.user_message }}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ chat.ai_response[:100] }}{% if chat.ai_response|length > 100 %}...{% endif %}</td>
                            <td>
                                <span class="badge badge-info">{{ chat.mcp_tool_used or 'N/A' }}</span>
                            </td>
                            <td>
                                <span class="badge badge-{{ 'success' if chat.mcp_success else 'error' }}">
                                    {{ 'Success' if chat.mcp_success else 'Failed' }}
                                </span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No recent activity</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function testConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<div class="spinner"></div> Testing...';
    
    fetch(`/api/servers/{{ server.id }}/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Connection test successful!');
        } else {
            alert('Connection test failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Connection test failed: ' + error.message);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function deleteServer(serverId) {
    if (confirm('Are you sure you want to delete this cluster? This action cannot be undone.')) {
        fetch(`/api/servers/${serverId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/';
            } else {
                alert('Failed to delete cluster. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the cluster.');
        });
    }
}
</script>
{% endblock %}